name: Supercharged Recon Bot

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Target Domain'
        required: true
        default: 'tesla.com'

jobs:
  recon-and-attack:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      # üõ†Ô∏è FIX IS HERE: Install the missing library for Naabu
      - name: Install System Dependencies
        run: sudo apt-get update && sudo apt-get install -y libpcap-dev

      - name: Install Arsenal
        run: |
          go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest
          go install -v github.com/projectdiscovery/naabu/v2/cmd/naabu@latest
          go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          go install -v github.com/sensepost/gowitness@latest

      - name: Run Recon Chain
        run: |
          mkdir -p screenshots

          # A. Find Subdomains
          echo "üîç Finding Subdomains..."
          subfinder -d ${{ inputs.domain }} -silent > subs.txt
          
          # B. Port Scan (Now works thanks to libpcap!)
          echo "üö™ Scanning Ports..."
          # We use -c 50 to not overload the GitHub runner
          naabu -list subs.txt -top-ports 100 -c 50 -silent > open_ports.txt
          
          # C. Check for Live Web Servers
          echo "üì∂ Checking Live Sites..."
          # If naabu found nothing, we fallback to the subdomains list to avoid crash
          if [ -s open_ports.txt ]; then
            cat open_ports.txt | httpx -silent -title -tech-detect -status-code > live_full.txt
          else
            cat subs.txt | httpx -silent -title -tech-detect -status-code > live_full.txt
          fi
          
          # Clean list for tools that just need URLs
          cat live_full.txt | awk '{print $1}' > urls.txt

          # D. Vulnerability Scan
          echo "‚ò¢Ô∏è Running Nuclei Vulnerability Scan..."
          # Scanning for Critical and High bugs
          if [ -s urls.txt ]; then
             nuclei -l urls.txt -severity critical,high -silent -o vulns.txt
          else
             touch vulns.txt
          fi

          # E. Visual Recon
          echo "üì∏ Taking Screenshots..."
          if [ -s urls.txt ]; then
            gowitness scan file -f urls.txt --write-db --screenshot-path ./screenshots/
          fi

          # Save counts for Telegram
          echo "SUB_COUNT=$(wc -l < subs.txt || echo 0)" >> $GITHUB_ENV
          echo "LIVE_COUNT=$(wc -l < urls.txt || echo 0)" >> $GITHUB_ENV
          echo "VULN_COUNT=$(wc -l < vulns.txt || echo 0)" >> $GITHUB_ENV

      - name: Zip Results
        run: zip -r report.zip screenshots/ live_full.txt vulns.txt

      - name: Send to Telegram
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          document: report.zip
          message: |
            üö® *New Recon Report*
            *Target:* ${{ inputs.domain }}
            
            üìä *Stats:*
            ‚Ä¢ üîç Subdomains: ${{ env.SUB_COUNT }}
            ‚Ä¢ üì∂ Live Sites: ${{ env.LIVE_COUNT }}
            ‚Ä¢ ‚ò¢Ô∏è *CRITICAL VULNS:* ${{ env.VULN_COUNT }}
            
            _Detailed report and screenshots attached._
          format: markdown
